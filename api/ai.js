// ===== IN√çCIO DO C√ìDIGO COMPLETO =====
// ================================================================================
// üèÜ CVC ITAQUA - API H√çBRIDA COMPLETA (Claude + GPT-4o-mini)
// ================================================================================
// Vers√£o: 4.2.0-stable
// Autor: Sistema CVC Itaqua
// √öltima atualiza√ß√£o: 2025-07-29
// Foco: Estabilidade e prompt refor√ßado para an√°lise de imagem.
// ================================================================================

// SE√á√ÉO 1: CONFIGURA√á√ïES E TEMPLATES
const templates = {
  'A√©reo M√∫ltiplas Op√ß√µes': `*Passagens A√©reas - Op√ß√µes Dispon√≠veis*

üìã *OP√á√ÉO 1: [COMPANHIA_1]*
üóìÔ∏è [DATA_IDA_1] a [DATA_VOLTA_1] ([DURACAO_1])
‚úàÔ∏è Ida: [DATA_IDA_1] - [AEROPORTO_ORIGEM_1] [HORA_IDA_1] / [AEROPORTO_DESTINO_1] [HORA_CHEGADA_1]
‚úàÔ∏è Volta: [DATA_VOLTA_1] - [AEROPORTO_DESTINO_VOLTA_1] [HORA_SAIDA_VOLTA_1] / [AEROPORTO_ORIGEM_VOLTA_1] [HORA_CHEGADA_VOLTA_1]
üí∞ R$ [VALOR_TOTAL_1] para [COMPOSICAO_PASSAGEIROS_1]
üí≥ [FORMA_PAGAMENTO_1]
üîó [LINK_CVC_1]

üìã *OP√á√ÉO 2: [COMPANHIA_2]*
üóìÔ∏è [DATA_IDA_2] a [DATA_VOLTA_2] ([DURACAO_2])
‚úàÔ∏è Ida: [DATA_IDA_2] - [AEROPORTO_ORIGEM_2] [HORA_IDA_2] / [AEROPORTO_DESTINO_2] [HORA_CHEGADA_2]
‚úàÔ∏è Volta: [DATA_VOLTA_2] - [AEROPORTO_DESTINO_VOLTA_2] [HORA_SAIDA_VOLTA_2] / [AEROPORTO_ORIGEM_VOLTA_2] [HORA_CHEGADA_VOLTA_2]
üí∞ R$ [VALOR_TOTAL_2] para [COMPOSICAO_PASSAGEIROS_2]
üí≥ [FORMA_PAGAMENTO_2]
üîó [LINK_CVC_2]

‚ö†Ô∏è Valores sujeitos a altera√ß√£o e disponibilidade! A melhor forma de garantir o pre√ßo √© efetuando a compra.

üìû D√∫vidas? Estamos aqui para ajudar voc√™ a escolher a melhor op√ß√£o!`,
  'A√©reo Facial': `*Passagem A√©rea*
[COMPANHIA_AEREA] 
[DATA_IDA] - [AEROPORTO_ORIGEM] [HORA_SAIDA] / [AEROPORTO_DESTINO] [HORA_CHEGADA]
[DATA_VOLTA] - [AEROPORTO_DESTINO_VOLTA] [HORA_SAIDA_VOLTA] / [AEROPORTO_ORIGEM_VOLTA] [HORA_CHEGADA_VOLTA]

üí∞ R$ [VALOR_TOTAL] para [COMPOSICAO_PASSAGEIROS]
üí≥ [FORMA_PAGAMENTO]
üîó [LINK_CVC]

‚ö†Ô∏è Valores sujeitos a altera√ß√£o e disponibilidade! A melhor forma de garantir o pre√ßo √© efetuando a compra.`,
  'Hotel': `*Hospedagem*
üè® [NOME_HOTEL] - [CATEGORIA_ESTRELAS]‚≠ê
üìç [LOCALIZACAO_HOTEL]
üóìÔ∏è [DATA_CHECK_IN] a [DATA_CHECK_OUT] ([QTDE_NOITES] noites)
üë• [QTDE_ADULTOS] adultos[QTDE_CRIANCAS_TEXTO]

üè† *Acomoda√ß√£o:*
[TIPO_QUARTO] com [REGIME_ALIMENTACAO]

‚úÖ *Inclui:*
‚Ä¢ [TIPO_CAFE]
‚Ä¢ [WIFI_INCLUSO]
‚Ä¢ [SERVICOS_INCLUSOS]

üí∞ R$ [VALOR_TOTAL_HOSPEDAGEM] para toda a estadia
üí≥ Parcelamento: [QTDE_PARCELAS]x de R$ [VALOR_PARCELA_HOTEL]

‚ö†Ô∏è Tarifas sujeitas √† disponibilidade no momento da reserva.`
};
const aeroportos = { 'CGH': 'Congonhas', 'GRU': 'Guarulhos', 'VCP': 'Viracopos', 'SDU': 'Santos Dumont', 'GIG': 'Gale√£o', 'RAO': 'Ribeir√£o Preto', 'BPS': 'Porto Seguro', 'SSA': 'Salvador', 'IOS': 'Ilh√©us', 'BSB': 'Bras√≠lia', 'CNF': 'Confins', 'PLU': 'Pampulha', 'CWB': 'Afonso Pena', 'IGU': 'Foz do Igua√ßu', 'REC': 'Recife', 'FOR': 'Fortaleza', 'MAO': 'Manaus', 'BEL': 'Bel√©m', 'CGB': 'Cuiab√°', 'CGR': 'Campo Grande', 'AJU': 'Aracaju', 'MCZ': 'Macei√≥', 'JPA': 'Jo√£o Pessoa', 'NAT': 'Natal', 'THE': 'Teresina', 'SLZ': 'S√£o Lu√≠s', 'VIX': 'Vit√≥ria', 'FLN': 'Florian√≥polis', 'POA': 'Porto Alegre' };
const PRECOS_MODELOS = { 'gpt-4o': { input: 0.005, output: 0.015 }, 'gpt-4o-mini': { input: 0.00015, output: 0.0006 }, 'claude-3-5-sonnet-20240620': { input: 0.003, output: 0.015 } };
const USD_TO_BRL = 5.2;
const MAX_TOKENS = 2500;

// ================================================================================
// üéØ SE√á√ÉO 2: HANDLER PRINCIPAL (com logging aprimorado)
// ================================================================================

export default async function handler(req, res) {
  try {
    console.log('[HANDLER] Iniciando processamento da requisi√ß√£o.');
    // Configura√ß√£o de CORS e Headers
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');
    res.setHeader('Content-Type', 'application/json; charset=utf-8');
    res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate');

    if (req.method === 'OPTIONS') {
      console.log('[HANDLER] Requisi√ß√£o OPTIONS recebida. Respondendo com CORS OK.');
      return res.status(200).json({ message: 'CORS OK' });
    }
    if (req.method === 'GET') {
        console.log('[HANDLER] Requisi√ß√£o GET recebida. Respondendo com status da API.');
        return res.status(200).json({ 
            message: 'CVC Itaqua API H√≠brida',
            version: '4.2.0-stable',
            modelos: {
              texto: 'gpt-4o-mini',
              imagem: 'claude-3-5-sonnet-20240620',
              fallback: 'gpt-4o'
            }
        });
    }
    if (req.method !== 'POST') {
      console.error(`[HANDLER] M√©todo n√£o permitido: ${req.method}`);
      return res.status(405).json({ error: 'M√©todo n√£o permitido' });
    }

    // Valida√ß√£o do corpo da requisi√ß√£o
    console.log('[HANDLER] Validando corpo da requisi√ß√£o...');
    if (!req.body) {
      console.error('[HANDLER] Erro: Corpo da requisi√ß√£o ausente.');
      return res.status(400).json({ error: 'Corpo da requisi√ß√£o obrigat√≥rio' });
    }
    const { prompt, temImagem, arquivo } = req.body;
    if (!prompt || typeof prompt !== 'string') {
      console.error('[HANDLER] Erro: Prompt ausente ou inv√°lido.');
      return res.status(400).json({ error: 'Prompt obrigat√≥rio' });
    }
    console.log(`[HANDLER] Dados recebidos: Imagem=${temImagem}, Prompt=${prompt.length} chars`);

    // Processamento principal
    const startTime = Date.now();
    const { modelo, estrategia, fallback } = selecionarModeloHibrido(temImagem);
    console.log(`[HANDLER] Estrat√©gia definida: ${estrategia}`);

    const template = selecionarTemplate(req.body);
    console.log('[HANDLER] Template selecionado.');
    
    const isMultiple = detectarMultiplasOpcoes(prompt);
    const promptFinal = construirPromptOtimizado({ temImagem, promptBase: prompt, template, isMultiple });
    console.log('[HANDLER] Prompt final constru√≠do.');

    const resultado = await chamarIAHibrida(promptFinal, temImagem, arquivo, modelo, fallback);
    console.log(`[HANDLER] IA respondeu com sucesso usando o modelo: ${resultado.modelo_usado}`);

    const responseProcessada = processarResposta(resultado.content);
    console.log('[HANDLER] Resposta da IA processada.');
    
    const metricas = calcularMetricasHibridas(resultado, startTime, estrategia);
    console.log(`[HANDLER] M√©tricas calculadas. Custo: R$ ${metricas.custo.brl.toFixed(4)}`);

    console.log(`[HANDLER] Processamento conclu√≠do em ${Date.now() - startTime}ms. Enviando resposta.`);
    return res.status(200).json({
      success: true,
      choices: [{ message: { content: responseProcessada } }],
      metricas: metricas,
    });

  } catch (error) {
    console.error('üí• [ERRO FATAL NO HANDLER] üí•', error);
    return res.status(500).json({
      success: false,
      error: {
        message: `Ocorreu um erro inesperado no servidor: ${error.message}`,
        type: 'SERVER_ERROR',
        details: error.stack
      }
    });
  }
}

// ================================================================================
// ü§ñ SE√á√ÉO 3: SISTEMA H√çBRIDO DE IA
// ================================================================================

function selecionarModeloHibrido(temImagem) {
  if (temImagem) {
    return {
      modelo: 'claude-3-5-sonnet-20240620',
      estrategia: 'Claude 3.5 Sonnet para an√°lise visual',
      fallback: 'gpt-4o',
    };
  } else {
    return {
      modelo: 'gpt-4o-mini',
      estrategia: 'GPT-4o-mini para processamento de texto',
      fallback: 'gpt-4o',
    };
  }
}

async function chamarIAHibrida(prompt, temImagem, arquivo, modelo, fallbackModelo) {
  try {
    if (temImagem) {
      console.log(`[IA-H√çBRIDA] Tentando com o modelo principal de imagem: ${modelo}`);
      return await chamarClaudeOtimizado(prompt, arquivo, modelo);
    } else {
      console.log(`[IA-H√çBRIDA] Tentando com o modelo principal de texto: ${modelo}`);
      return await chamarOpenAIOtimizada(prompt, false, null, modelo);
    }
  } catch (error) {
    console.error(`‚ùå [IA-H√çBRIDA] Falha no modelo principal (${modelo}): ${error.message}`);
    console.log(`üîÑ [IA-H√çBRIDA] Acionando fallback para o modelo: ${fallbackModelo}`);
    try {
        return await chamarOpenAIOtimizada(prompt, temImagem, arquivo, fallbackModelo);
    } catch (fallbackError) {
        console.error(`‚ùå [IA-H√çBRIDA] Falha tamb√©m no modelo de fallback (${fallbackModelo}): ${fallbackError.message}`);
        throw new Error(`Principal falhou: (${error.message}) | Fallback falhou: (${fallbackError.message})`);
    }
  }
}

// ================================================================================
// üèóÔ∏è SE√á√ÉO 4: PROMPTS OTIMIZADOS
// ================================================================================
function construirPromptOtimizado({ temImagem, promptBase, template, isMultiple }) {
    if (temImagem) {
        return construirPromptClaude(promptBase, template, isMultiple);
    }
    return construirPromptGPTMini(promptBase, template, isMultiple);
}

function construirPromptClaude(promptBase, template, isMultiple) {
  return `Voc√™ √© um assistente de IA especializado em extrair dados de imagens de or√ßamentos de voos. Sua √∫nica tarefa √© analisar a imagem fornecida e preencher o template com as informa√ß√µes extra√≠das. N√£o converse, n√£o pe√ßa a imagem, apenas analise e responda no formato solicitado.

TEMPLATE DE SA√çDA OBRIGAT√ìRIO:
${template}

INSTRU√á√ïES:
1.  **A√á√ÉO OBRIGAT√ìRIA:** Analise a imagem. A imagem √© a fonte prim√°ria de dados.
2.  **EXTRAIA DA IMAGEM:**
    * Companhia(s) A√©rea(s).
    * Datas e hor√°rios de ida e volta.
    * Aeroportos de origem e destino (converta siglas como GRU para Guarulhos).
    * Valor total em R$.
    * Qualquer informa√ß√£o sobre parcelamento.
3.  **M√öLTIPLAS OP√á√ïES:** ${isMultiple ? "A imagem cont√©m v√°rias op√ß√µes. Preencha uma se√ß√£o para cada uma (OP√á√ÉO 1, OP√á√ÉO 2...)." : "A imagem cont√©m uma √∫nica op√ß√£o. Preencha o template para ela."}
4.  **DADOS DE CONTEXTO:** O texto abaixo √© apenas para contexto (ex: n√∫mero de passageiros). Use-o para complementar, mas os dados da imagem t√™m prioridade.
    * Contexto do usu√°rio: ${promptBase}

Responda apenas com o template preenchido.`;
}

function construirPromptGPTMini(promptBase, template, isMultiple) {
    return `Voc√™ √© um assistente da CVC. Formate o or√ßamento abaixo usando EXATAMENTE o modelo fornecido.

MODELO:
${template}

DADOS DO CLIENTE:
${promptBase}

REGRAS:
- Use os dados para preencher os campos como [COMPANHIA_AEREA], [VALOR_TOTAL], etc.
- ${isMultiple ? "O texto cont√©m m√∫ltiplas op√ß√µes. Formate todas elas." : "O texto cont√©m uma √∫nica op√ß√£o."}
- Converta siglas de aeroportos para nomes completos (ex: GRU para Guarulhos).
- O resultado deve ser apenas o texto formatado, pronto para copiar e colar.`;
}

function detectarMultiplasOpcoes(prompt) {
    if (!prompt) return false;
    const texto = prompt.toLowerCase();
    const precos = (texto.match(/r\$.*\d/g) || []).length;
    const cias = (texto.match(/(gol|latam|azul)/gi) || []).length;
    return precos >= 2 || cias >= 2;
}

function selecionarTemplate({ tipos, prompt }) {
    if (detectarMultiplasOpcoes(prompt) && tipos?.includes('A√©reo Facial')) {
        return templates['A√©reo M√∫ltiplas Op√ß√µes'];
    }
    return templates[tipos?.[0]] || templates['A√©reo Facial'];
}


// ================================================================================
// üü†/üîµ SE√á√ïES 5 e 6: CHAMADAS √ÄS APIS
// ================================================================================

async function chamarClaudeOtimizado(prompt, arquivo, modelo) {
    console.log(`[CLAUDE] Preparando chamada para o modelo ${modelo}...`);
    if (!process.env.ANTHROPIC_API_KEY) throw new Error('Chave da API da Anthropic n√£o encontrada.');
    
    const base64Match = arquivo.match(/data:image\/[^;]+;base64,(.+)/);
    if (!base64Match) throw new Error('Formato de imagem Base64 inv√°lido para Claude.');
    
    const content = [{ type: "text", text: prompt }, { type: "image", source: { type: "base64", media_type: arquivo.match(/data:(image\/[^;]+)/)[1], data: base64Match[1] } }];

    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'x-api-key': process.env.ANTHROPIC_API_KEY, 'Content-Type': 'application/json', 'anthropic-version': '2023-06-01' },
        body: JSON.stringify({ model: modelo, max_tokens: MAX_TOKENS, messages: [{ role: 'user', content }] })
    });

    if (!response.ok) {
        const errorText = await response.text();
        console.error(`[CLAUDE] Erro na API: ${response.status}`, errorText);
        throw new Error(`Erro na API Claude (${response.status}): ${errorText.substring(0, 150)}`);
    }

    const data = await response.json();
    if (!data.content?.[0]?.text) throw new Error('Resposta da API Claude veio em formato inesperado.');
    
    console.log(`[CLAUDE] Chamada bem-sucedida. Tokens usados: ${data.usage?.output_tokens || 'N/A'}`);
    return { content: data.content[0].text, usage: data.usage, modelo_usado: modelo };
}

async function chamarOpenAIOtimizada(prompt, temImagem, arquivo, modelo) {
    console.log(`[OPENAI] Preparando chamada para o modelo ${modelo}...`);
    if (!process.env.OPENAI_API_KEY) throw new Error('Chave da API da OpenAI n√£o encontrada.');

    let messages;
    if (temImagem) {
        if (!arquivo || !arquivo.startsWith('data:image')) throw new Error('Arquivo de imagem inv√°lido para OpenAI.');
        messages = [{ role: "user", content: [{ type: "text", text: prompt }, { type: "image_url", image_url: { url: arquivo } }] }];
    } else {
        messages = [{ role: "user", content: prompt }];
    }

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: modelo, messages, max_tokens: MAX_TOKENS })
    });

    if (!response.ok) {
        const errorText = await response.text();
        console.error(`[OPENAI] Erro na API: ${response.status}`, errorText);
        throw new Error(`Erro na API OpenAI (${response.status}): ${errorText.substring(0, 150)}`);
    }

    const data = await response.json();
    if (!data.choices?.[0]?.message?.content) throw new Error('Resposta da API OpenAI veio em formato inesperado.');

    console.log(`[OPENAI] Chamada bem-sucedida. Tokens usados: ${data.usage?.total_tokens || 'N/A'}`);
    return { content: data.choices[0].message.content, usage: data.usage, modelo_usado: modelo };
}

// ================================================================================
// üîß/üí∞ SE√á√ïES 7 e 8: UTILIT√ÅRIOS E PROCESSAMENTO
// ================================================================================
function processarResposta(response) {
    let processada = response.replace(/TEMPLAT. DE SA√çDA OBRIGAT√ìRIO:/g, '').trim();
    Object.entries(aeroportos).forEach(([sigla, nome]) => {
      const regex = new RegExp(`\\b${sigla}\\b`, 'gi');
      processada = processada.replace(regex, nome);
    });
    return processada.replace(/\n\s*\n/g, '\n\n').trim();
}

function calcularMetricasHibridas(resultado, startTime, estrategia) {
  const tokensInput = resultado.usage?.prompt_tokens || resultado.usage?.input_tokens || 0;
  const tokensOutput = resultado.usage?.completion_tokens || resultado.usage?.output_tokens || 0;
  
  const modeloUsado = resultado.modelo_usado;
  const precosModelo = PRECOS_MODELOS[modeloUsado] || { input: 0, output: 0 };
  
  const custoUSD = (tokensInput / 1000) * precosModelo.input + (tokensOutput / 1000) * precosModelo.output;
  const custoBRL = custoUSD * USD_TO_BRL;

  const custoGPT4o = (tokensInput / 1000) * PRECOS_MODELOS['gpt-4o'].input + 
                     (tokensOutput / 1000) * PRECOS_MODELOS['gpt-4o'].output;
  const economiaBRL = (custoGPT4o * USD_TO_BRL) - custoBRL;
  
  return {
    modelo_usado: modeloUsado,
    estrategia: estrategia,
    tokens: { input: tokensInput, output: tokensOutput, total: tokensInput + tokensOutput },
    custo: { usd: custoUSD, brl: custoBRL },
    economia: { vs_gpt4o_brl: economiaBRL },
    performance: { tempo_processamento_ms: Date.now() - startTime }
  };
}
// ===== FIM DO C√ìDIGO COMPLETO =====
