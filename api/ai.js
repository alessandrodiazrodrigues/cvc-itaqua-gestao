// ===== CORRE√á√ÉO ULTRA ESPEC√çFICA - ANTI-INVEN√á√ÉO DE VOLTA =====
// ================================================================================
// üèÜ CVC ITAQUA - API ULTRA CORRIGIDA v4.5.0-ultra
// ================================================================================
// FOCO ABSOLUTO: Impedir que a IA invente hor√°rios de volta para voos somente ida
// ================================================================================

const templates = {
  'A√©reo Somente Ida': `*Passagem A√©rea - Somente Ida*
üè∑Ô∏è [COMPANHIA_AEREA]
üóìÔ∏è [DATA_IDA] (Somente ida)
‚úàÔ∏è [DATA_IDA] - [AEROPORTO_ORIGEM] [HORA_SAIDA] / [AEROPORTO_DESTINO] [HORA_CHEGADA]

üí∞ R$ [VALOR_TOTAL] para [COMPOSICAO_PASSAGEIROS]
üí≥ [FORMA_PAGAMENTO]
üîó [LINK_CVC]

‚ö†Ô∏è Passagem somente de ida - sem retorno inclu√≠do`,

  'A√©reo M√∫ltiplas Somente Ida': `*Passagens A√©reas - Op√ß√µes Somente Ida*

üìã *OP√á√ÉO 1: [COMPANHIA_1]*
üóìÔ∏è [DATA_IDA_1] (Somente ida)
‚úàÔ∏è [DATA_IDA_1] - [AEROPORTO_ORIGEM_1] [HORA_IDA_1] / [AEROPORTO_DESTINO_1] [HORA_CHEGADA_1]
üí∞ R$ [VALOR_TOTAL_1] para [COMPOSICAO_PASSAGEIROS_1]
üí≥ [FORMA_PAGAMENTO_1]
üîó [LINK_CVC_1]

üìã *OP√á√ÉO 2: [COMPANHIA_2]*
üóìÔ∏è [DATA_IDA_2] (Somente ida)
‚úàÔ∏è [DATA_IDA_2] - [AEROPORTO_ORIGEM_2] [HORA_IDA_2] / [AEROPORTO_DESTINO_2] [HORA_CHEGADA_2]
üí∞ R$ [VALOR_TOTAL_2] para [COMPOSICAO_PASSAGEIROS_2]
üí≥ [FORMA_PAGAMENTO_2]
üîó [LINK_CVC_2]

‚ö†Ô∏è Todas as op√ß√µes s√£o SOMENTE IDA - sem retorno inclu√≠do
üìû D√∫vidas? Estamos aqui para ajudar!`
};

const aeroportos = {
  'CGH': 'Congonhas', 'GRU': 'Guarulhos', 'VCP': 'Viracopos',
  'SDU': 'Santos Dumont', 'GIG': 'Gale√£o', 'RAO': 'Ribeir√£o Preto',
  'BSB': 'Bras√≠lia', 'CNF': 'Confins', 'PLU': 'Pampulha',
  'CWB': 'Afonso Pena', 'IGU': 'Foz do Igua√ßu', 'REC': 'Recife',
  'FOR': 'Fortaleza', 'MAO': 'Manaus', 'BEL': 'Bel√©m',
  'CGB': 'Cuiab√°', 'CGR': 'Campo Grande', 'AJU': 'Aracaju',
  'MCZ': 'Macei√≥', 'JPA': 'Jo√£o Pessoa', 'NAT': 'Natal',
  'THE': 'Teresina', 'SLZ': 'S√£o Lu√≠s', 'VIX': 'Vit√≥ria',
  'FLN': 'Florian√≥polis', 'POA': 'Porto Alegre', 'BPS': 'Porto Seguro',
  'SSA': 'Salvador', 'IOS': 'Ilh√©us'
};

const PRECOS_MODELOS = {
  'gpt-4o': { input: 0.005, output: 0.015 },
  'gpt-4o-mini': { input: 0.00015, output: 0.0006 },
  'claude-3-5-sonnet-20240620': { input: 0.003, output: 0.015 }
};

const USD_TO_BRL = 5.2;
const MAX_TOKENS = 2500;

// ================================================================================
// üéØ HANDLER PRINCIPAL
// ================================================================================

export default async function handler(req, res) {
  const startTime = Date.now();
  
  try {
    console.log('[ULTRA-FIX] Iniciando processamento...');
    
    // Configura√ß√£o de CORS
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');
    res.setHeader('Content-Type', 'application/json; charset=utf-8');

    if (req.method === 'OPTIONS') {
      return res.status(200).json({ message: 'CORS OK' });
    }

    if (req.method === 'GET') {
      return res.status(200).json({
        message: 'CVC Itaqua API Ultra Corrigida',
        version: '4.5.0-ultra',
        status: 'ANTI-INVEN√á√ÉO DE VOLTA ATIVO',
        timestamp: new Date().toISOString()
      });
    }

    if (req.method !== 'POST') {
      return res.status(405).json({ 
        success: false,
        error: 'M√©todo n√£o permitido' 
      });
    }

    // VALIDA√á√ÉO
    if (!req.body?.prompt) {
      return res.status(400).json({
        success: false,
        error: 'Prompt obrigat√≥rio'
      });
    }

    const { prompt, temImagem, arquivo } = req.body;
    console.log(`[ULTRA-FIX] Prompt recebido: ${prompt.length} chars`);

    // AN√ÅLISE ULTRA RIGOROSA
    const analise = analisarVooUltraRigoroso(prompt);
    console.log('[ULTRA-FIX] An√°lise:', analise);

    // SELE√á√ÉO FOR√áADA DO TEMPLATE CORRETO
    const template = selecionarTemplateForcado(analise);
    console.log(`[ULTRA-FIX] Template for√ßado: ${template.nome}`);

    // PROMPT ULTRA ESPEC√çFICO
    const promptFinal = construirPromptUltraEspecifico(prompt, template, analise);

    // CHAMADA PARA IA
    const { modelo, estrategia, fallback } = selecionarModeloHibrido(temImagem);
    const resultado = await chamarIASegura(promptFinal, temImagem, arquivo, modelo, fallback);
    
    const responseProcessada = processarResposta(resultado.content);
    const metricas = calcularMetricas(resultado, startTime, estrategia);

    console.log(`[ULTRA-FIX] Conclu√≠do: ${Date.now() - startTime}ms`);

    return res.status(200).json({
      success: true,
      choices: [{ 
        message: { 
          content: responseProcessada 
        } 
      }],
      metricas: metricas
    });

  } catch (error) {
    console.error('üí• [ULTRA-FIX ERROR] üí•', error.message);
    
    return res.status(500).json({
      success: false,
      error: {
        message: `Erro no servidor: ${error.message}`,
        type: 'SERVER_ERROR',
        version: '4.5.0-ultra'
      }
    });
  }
}

// ================================================================================
// üîç AN√ÅLISE ULTRA RIGOROSA
// ================================================================================

function analisarVooUltraRigoroso(texto) {
  console.log('[ULTRA-AN√ÅLISE] Iniciando an√°lise ultra rigorosa...');
  
  if (!texto) {
    return { tipo: 'somente_ida', multiplasOpcoes: false, confianca: 0 };
  }

  const textoLower = texto.toLowerCase();
  
  // DETECTAR M√öLTIPLAS OP√á√ïES
  const precos = (textoLower.match(/r\$[\s]*[\d.,]+/gi) || []).length;
  const totais = (textoLower.match(/total.*\d+.*adult/gi) || []).length;
  const links = (textoLower.match(/https:\/\/www\.cvc\.com\.br\/carrinho/gi) || []).length;
  
  const multiplasOpcoes = Math.max(precos, totais, links) >= 2;
  const quantidadeOpcoes = multiplasOpcoes ? Math.max(precos, totais, links) : 1;
  
  console.log(`[ULTRA-AN√ÅLISE] M√∫ltiplas op√ß√µes: ${multiplasOpcoes} (${quantidadeOpcoes})`);

  // AN√ÅLISE ULTRA ESPEC√çFICA PARA SOMENTE IDA
  const indicadoresVolta = [
    // Buscar por palavras expl√≠citas de volta
    textoLower.includes('volta'),
    textoLower.includes('retorno'),
    textoLower.includes('return'),
    // Buscar por padr√µes de hor√°rios de volta
    /volta.*\d{2}:\d{2}/gi.test(textoLower),
    // Buscar por m√∫ltiplas datas DIFERENTES (n√£o repetidas)
    temDatasRealmenteDistintas(texto),
    // Buscar por men√ß√£o de dura√ß√£o de viagem
    /\d+ dias.*\d+ noites/gi.test(textoLower)
  ];
  
  const contemVolta = indicadoresVolta.some(Boolean);
  
  console.log('[ULTRA-AN√ÅLISE] Indicadores de volta:', indicadoresVolta);
  console.log(`[ULTRA-AN√ÅLISE] Cont√©m volta: ${contemVolta}`);
  
  // DECIS√ÉO ULTRA CONSERVADORA
  // Se N√ÉO h√° indicadores claros de volta, √© SOMENTE IDA
  const tipoViagem = contemVolta ? 'ida_volta' : 'somente_ida';
  const confianca = contemVolta ? 2 : 4; // Alta confian√ßa para somente ida
  
  console.log(`[ULTRA-AN√ÅLISE] DECIS√ÉO FINAL: ${tipoViagem.toUpperCase()}`);

  return {
    tipo: tipoViagem,
    multiplasOpcoes: multiplasOpcoes,
    quantidadeOpcoes: quantidadeOpcoes,
    confianca: confianca,
    contemVolta: contemVolta,
    indicadores: {
      precos, totais, links,
      volta: indicadoresVolta
    }
  };
}

function temDatasRealmenteDistintas(texto) {
  // Extrair todas as datas do texto
  const datasCompletas = texto.match(/\d{2} de \w+|\d{2}\/\d{2}\/\d{4}|\d{2}\/\d{2}/gi) || [];
  
  // Normalizar as datas para compara√ß√£o
  const datasNormalizadas = datasCompletas.map(data => {
    return data.toLowerCase().replace(/\s+/g, ' ').trim();
  });
  
  // Contar datas √∫nicas
  const datasUnicas = [...new Set(datasNormalizadas)];
  
  console.log('[ULTRA-AN√ÅLISE] Datas encontradas:', datasCompletas);
  console.log('[ULTRA-AN√ÅLISE] Datas √∫nicas:', datasUnicas);
  
  // S√≥ considera m√∫ltiplas datas se h√° REALMENTE datas diferentes
  return datasUnicas.length >= 2;
}

// ================================================================================
// üéØ SELE√á√ÉO FOR√áADA DE TEMPLATE
// ================================================================================

function selecionarTemplateForcado(analise) {
  console.log('[TEMPLATE-FOR√áADO] Selecionando template...');
  
  let templateNome = '';
  let template = '';
  
  // FOR√áAR TEMPLATE BASEADO NA AN√ÅLISE ULTRA RIGOROSA
  if (analise.tipo === 'somente_ida') {
    if (analise.multiplasOpcoes) {
      templateNome = 'A√©reo M√∫ltiplas Somente Ida';
      template = templates['A√©reo M√∫ltiplas Somente Ida'];
    } else {
      templateNome = 'A√©reo Somente Ida';
      template = templates['A√©reo Somente Ida'];
    }
  } else {
    // Para ida/volta, usar templates padr√£o (n√£o definidos aqui pois foco √© somente ida)
    templateNome = 'A√©reo Ida e Volta';
    template = `*Passagem A√©rea - Ida e Volta*
[DADOS_IDA_VOLTA]`;
  }
  
  console.log(`[TEMPLATE-FOR√áADO] Selecionado: ${templateNome}`);
  
  return {
    nome: templateNome,
    conteudo: template
  };
}

// ================================================================================
// üèóÔ∏è PROMPT ULTRA ESPEC√çFICO - ANTI-INVEN√á√ÉO
// ================================================================================

function construirPromptUltraEspecifico(promptBase, template, analise) {
  console.log('[PROMPT-ULTRA] Construindo prompt anti-inven√ß√£o...');
  
  let prompt = `VOC√ä √â UM ASSISTENTE ESPECIALIZADO EM OR√áAMENTOS DE VIAGEM.

üö® INSTRU√á√ÉO CR√çTICA ABSOLUTA:
${analise.tipo === 'somente_ida' ? 
  `ESTE √â UM VOO SOMENTE IDA! N√ÉO INVENTE INFORMA√á√ïES DE VOLTA!` : 
  `Este √© um voo ida e volta com dados de retorno.`}

AN√ÅLISE REALIZADA:
- Tipo detectado: ${analise.tipo.toUpperCase()}
- M√∫ltiplas op√ß√µes: ${analise.multiplasOpcoes ? 'SIM' : 'N√ÉO'}
- Quantidade: ${analise.quantidadeOpcoes}
- Cont√©m volta: ${analise.contemVolta ? 'SIM' : 'N√ÉO'}

TEMPLATE OBRIGAT√ìRIO (USE EXATAMENTE ESTE FORMATO):
${template.conteudo}

DADOS FORNECIDOS PELO CLIENTE:
${promptBase}

`;

  if (analise.tipo === 'somente_ida') {
    prompt += `
üö®üö®üö® REGRAS ABSOLUTAS PARA SOMENTE IDA üö®üö®üö®:

1. N√ÉO ADICIONE linha "‚úàÔ∏è Volta:" - PROIBIDO!
2. N√ÉO INVENTE hor√°rios de retorno - PROIBIDO!
3. USE apenas "(Somente ida)" na data - OBRIGAT√ìRIO!
4. N√ÉO CALCULE dura√ß√£o em dias/noites - PROIBIDO!
5. USE apenas os dados de IDA fornecidos - OBRIGAT√ìRIO!

EXEMPLO CORRETO PARA M√öLTIPLAS OP√á√ïES SOMENTE IDA:

*Passagens A√©reas - Op√ß√µes Somente Ida*

üìã *OP√á√ÉO 1: Gol*
üóìÔ∏è 01 de agosto (Somente ida)
‚úàÔ∏è 01/ago - Viracopos 17:55 / Bras√≠lia 19:30
üí∞ R$ 373,06 para 1 Adulto
üí≥ Tarifa facial - N√£o reembols√°vel
üîó https://www.cvc.com.br/carrinho-dinamico/6888fd4866fac5c6de086f77

üìã *OP√á√ÉO 2: Gol*
üóìÔ∏è 01 de agosto (Somente ida)
‚úàÔ∏è 01/ago - Guarulhos 06:00 / Bras√≠lia 07:45
üí∞ R$ 489,48 para 1 Adulto
üí≥ Tarifa facial - N√£o reembols√°vel
üîó https://www.cvc.com.br/carrinho-dinamico/6888fd59790b60759b7d4300

‚ö†Ô∏è Todas as op√ß√µes s√£o SOMENTE IDA - sem retorno inclu√≠do
üìû D√∫vidas? Estamos aqui para ajudar!

NUNCA ADICIONE INFORMA√á√ïES DE VOLTA QUE N√ÉO EXISTEM!
`;
  }

  prompt += `
INSTRU√á√ïES FINAIS:
- Converta siglas: VCP ‚Üí Viracopos, BSB ‚Üí Bras√≠lia, GRU ‚Üí Guarulhos
- Use APENAS dados reais do texto fornecido
- Mantenha links exatos como fornecidos
- Responda APENAS com o template preenchido
- N√ÉO adicione coment√°rios ou explica√ß√µes extras`;

  console.log('[PROMPT-ULTRA] Prompt constru√≠do, tamanho:', prompt.length);
  console.log('[PROMPT-ULTRA] Tipo foco:', analise.tipo);
  
  return prompt;
}

// ================================================================================
// ü§ñ SISTEMA H√çBRIDO (simplificado)
// ================================================================================

function selecionarModeloHibrido(temImagem) {
  if (temImagem === true) {
    return {
      modelo: 'claude-3-5-sonnet-20240620',
      estrategia: 'Claude 3.5 Sonnet para an√°lise visual',
      fallback: 'gpt-4o'
    };
  } else {
    return {
      modelo: 'gpt-4o-mini',
      estrategia: 'GPT-4o-mini para processamento de texto',
      fallback: 'gpt-4o'
    };
  }
}

async function chamarIASegura(prompt, temImagem, arquivo, modelo, fallbackModelo) {
  console.log(`[IA-ULTRA] Chamando modelo: ${modelo}`);
  
  try {
    if (temImagem === true) {
      return await chamarClaude(prompt, arquivo, modelo);
    } else {
      return await chamarOpenAI(prompt, false, null, modelo);
    }
  } catch (erro1) {
    console.error(`‚ùå [IA-ULTRA] Falha no modelo principal: ${erro1.message}`);
    
    try {
      console.log(`üîÑ [IA-ULTRA] Fallback: ${fallbackModelo}`);
      return await chamarOpenAI(prompt, temImagem, arquivo, fallbackModelo);
    } catch (erro2) {
      console.error(`‚ùå [IA-ULTRA] Falha no fallback: ${erro2.message}`);
      throw new Error(`Ambos modelos falharam. Principal: ${erro1.message}. Fallback: ${erro2.message}`);
    }
  }
}

// ================================================================================
// üü†/üîµ CHAMADAS DE API (mantidas iguais)
// ================================================================================

async function chamarClaude(prompt, arquivo, modelo) {
  if (!process.env.ANTHROPIC_API_KEY) {
    throw new Error('ANTHROPIC_API_KEY n√£o encontrada');
  }

  const base64Match = arquivo.match(/data:(image\/[^;]+);base64,(.+)/);
  if (!base64Match) {
    throw new Error('Formato de imagem base64 inv√°lido');
  }

  const content = [
    { type: "text", text: prompt },
    {
      type: "image",
      source: {
        type: "base64",
        media_type: base64Match[1],
        data: base64Match[2]
      }
    }
  ];

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'x-api-key': process.env.ANTHROPIC_API_KEY,
      'Content-Type': 'application/json',
      'anthropic-version': '2023-06-01'
    },
    body: JSON.stringify({
      model: modelo,
      max_tokens: MAX_TOKENS,
      messages: [{ role: 'user', content }]
    })
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Erro Claude ${response.status}: ${errorText.substring(0, 200)}`);
  }

  const data = await response.json();
  
  if (!data.content?.[0]?.text) {
    throw new Error('Resposta Claude inv√°lida');
  }

  return {
    content: data.content[0].text,
    usage: data.usage || { input_tokens: 0, output_tokens: 0 },
    modelo_usado: modelo
  };
}

async function chamarOpenAI(prompt, temImagem, arquivo, modelo) {
  if (!process.env.OPENAI_API_KEY) {
    throw new Error('OPENAI_API_KEY n√£o encontrada');
  }

  let messages;
  if (temImagem === true && arquivo) {
    messages = [
      {
        role: "user",
        content: [
          { type: "text", text: prompt },
          { type: "image_url", image_url: { url: arquivo } }
        ]
      }
    ];
  } else {
    messages = [{ role: "user", content: prompt }];
  }

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: modelo,
      messages: messages,
      max_tokens: MAX_TOKENS,
      temperature: 0.0 // Temperatura zero para m√°xima precis√£o
    })
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Erro OpenAI ${response.status}: ${errorText.substring(0, 200)}`);
  }

  const data = await response.json();

  if (!data.choices?.[0]?.message?.content) {
    throw new Error('Resposta OpenAI inv√°lida');
  }

  return {
    content: data.choices[0].message.content,
    usage: data.usage || { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },
    modelo_usado: modelo
  };
}

// ================================================================================
// üîß PROCESSAMENTO E UTILIT√ÅRIOS
// ================================================================================

function processarResposta(response) {
  if (!response || typeof response !== 'string') {
    return 'Erro: Resposta inv√°lida';
  }

  let processada = response.trim();

  // Convers√£o de aeroportos
  Object.entries(aeroportos).forEach(([sigla, nome]) => {
    const regex = new RegExp(`\\b${sigla}\\b`, 'gi');
    processada = processada.replace(regex, nome);
  });

  return processada.replace(/\n\s*\n/g, '\n\n').trim();
}

function calcularMetricas(resultado, startTime, estrategia) {
  const tokensInput = resultado.usage?.prompt_tokens || resultado.usage?.input_tokens || 0;
  const tokensOutput = resultado.usage?.completion_tokens || resultado.usage?.output_tokens || 0;
  const modeloUsado = resultado.modelo_usado || 'desconhecido';
  
  const precosModelo = PRECOS_MODELOS[modeloUsado] || { input: 0, output: 0 };
  
  const custoUSD = (tokensInput / 1000) * precosModelo.input + (tokensOutput / 1000) * precosModelo.output;
  const custoBRL = custoUSD * USD_TO_BRL;

  const custoGPT4o = (tokensInput / 1000) * PRECOS_MODELOS['gpt-4o'].input + 
                     (tokensOutput / 1000) * PRECOS_MODELOS['gpt-4o'].output;
  const economiaUSD = custoGPT4o - custoUSD;
  const economiaBRL = economiaUSD * USD_TO_BRL;
  
  return {
    modelo_usado: modeloUsado,
    estrategia: estrategia,
    tokens: {
      input: tokensInput,
      output: tokensOutput,
      total: tokensInput + tokensOutput
    },
    custo: {
      usd: custoUSD,
      brl: custoBRL
    },
    economia: {
      vs_gpt4o_usd: economiaUSD,
      vs_gpt4o_brl: economiaBRL,
      percentual: custoGPT4o > 0 ? ((economiaUSD / custoGPT4o) * 100).toFixed(1) + '%' : '0%'
    },
    performance: {
      tempo_processamento_ms: Date.now() - startTime
    }
  };
}

console.log('‚úÖ [ULTRA-FIX] CVC Itaqua API v4.5.0-ultra carregada');
console.log('üö® [MODO] ANTI-INVEN√á√ÉO DE VOLTA ATIVO');
console.log('üéØ [FOCO] Detec√ß√£o ultra rigorosa + Prompt extremamente espec√≠fico');
console.log('üîß [TEMPERATURA] 0.0 para m√°xima precis√£o');
console.log('üöÄ [STATUS] Pronto para eliminar inven√ß√µes!')
