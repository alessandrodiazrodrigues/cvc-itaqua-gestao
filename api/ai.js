// ================================================================================
// üèÜ CVC ITAQUA - API CORRIGIDA v5.2.0-clean
// ================================================================================
// FOCO: Or√ßamentos limpos sem cabe√ßalhos t√©cnicos + Detalhes de escalas
// ================================================================================

// ================================================================================
// üó∫Ô∏è MAPEAMENTO COMPLETO DE AEROPORTOS
// ================================================================================

const aeroportos = {
  // Principais aeroportos brasileiros
  'CGH': 'Congonhas (SP)', 'GRU': 'Guarulhos (SP)', 'VCP': 'Viracopos (SP)',
  'SDU': 'Santos Dumont (RJ)', 'GIG': 'Gale√£o (RJ)', 
  'BSB': 'Bras√≠lia (DF)', 'CNF': 'Confins (MG)', 'PLU': 'Pampulha (MG)',
  'CWB': 'Curitiba (PR)', 'IGU': 'Foz do Igua√ßu (PR)', 
  'REC': 'Recife (PE)', 'FOR': 'Fortaleza (CE)', 'SSA': 'Salvador (BA)',
  'MAO': 'Manaus (AM)', 'BEL': 'Bel√©m (PA)', 'CGB': 'Cuiab√° (MT)',
  'CGR': 'Campo Grande (MS)', 'AJU': 'Aracaju (SE)', 'MCZ': 'Macei√≥ (AL)',
  'JPA': 'Jo√£o Pessoa (PB)', 'NAT': 'Natal (RN)', 'THE': 'Teresina (PI)',
  'SLZ': 'S√£o Lu√≠s (MA)', 'VIX': 'Vit√≥ria (ES)', 'FLN': 'Florian√≥polis (SC)',
  'POA': 'Porto Alegre (RS)', 'BPS': 'Porto Seguro (BA)', 'IOS': 'Ilh√©us (BA)',
  'RAO': 'Ribeir√£o Preto (SP)', 'NVT': 'Navegantes (SC)', 'UDI': 'Uberl√¢ndia (MG)',
  'MOC': 'Montes Claros (MG)', 'JDF': 'Juiz de Fora (MG)', 'GYN': 'Goi√¢nia (GO)',
  'PNZ': 'Petrolina (PE)', 'JTC': 'Bauru (SP)', 'AQA': 'Araraquara (SP)',
  'PPB': 'Presidente Prudente (SP)', 'CXJ': 'Caxias do Sul (RS)',
  
  // Aeroportos internacionais importantes
  'EZE': 'Buenos Aires (Argentina)', 'MVD': 'Montevid√©u (Uruguai)',
  'ASU': 'Assun√ß√£o (Paraguai)', 'SCL': 'Santiago (Chile)', 'LIM': 'Lima (Peru)',
  'BOG': 'Bogot√° (Col√¥mbia)', 'UIO': 'Quito (Equador)', 'CCS': 'Caracas (Venezuela)',
  'MIA': 'Miami (EUA)', 'MCO': 'Orlando (EUA)', 'JFK': 'Nova York (EUA)',
  'LAX': 'Los Angeles (EUA)', 'CDG': 'Paris (Fran√ßa)', 'MAD': 'Madrid (Espanha)',
  'FCO': 'Roma (It√°lia)', 'LIS': 'Lisboa (Portugal)', 'LGW': 'Londres (Reino Unido)',
  'AMS': 'Amsterd√£ (Holanda)', 'FRA': 'Frankfurt (Alemanha)', 'ZUR': 'Zurich (Su√≠√ßa)',
  'DXB': 'Dubai (Emirados)', 'DOH': 'Doha (Catar)', 'IST': 'Istambul (Turquia)'
};

// ================================================================================
// üìã TEMPLATES LIMPOS (SEM CABE√áALHOS T√âCNICOS)
// ================================================================================

const TEMPLATES = {
  'A√©reo Facial': `*Passagem A√©rea - Somente Ida*
üè∑Ô∏è [COMPANHIA]
üóìÔ∏è [DATA] (Somente ida)
‚úàÔ∏è [DATA] - [ORIGEM] [HORA_IDA] / [DESTINO] [HORA_CHEGADA][DETALHES_VOO]
üí∞ R$ [VALOR] para [PASSAGEIROS]
üí≥ [PAGAMENTO]
üîó [LINK]

‚ö†Ô∏è Passagem somente de ida - sem retorno inclu√≠do`,

  'A√©reo M√∫ltiplas': `*Passagens A√©reas - Op√ß√µes Somente Ida*

üìã *OP√á√ÉO 1: [COMPANHIA_1]*
üóìÔ∏è [DATA_1] (Somente ida)
‚úàÔ∏è [DATA_1] - [ORIGEM_1] [HORA_IDA_1] / [DESTINO_1] [HORA_CHEGADA_1][DETALHES_VOO_1]
üí∞ R$ [VALOR_1] para [PASSAGEIROS_1]
üí≥ [PAGAMENTO_1]
üîó [LINK_1]

üìã *OP√á√ÉO 2: [COMPANHIA_2]*
üóìÔ∏è [DATA_2] (Somente ida)
‚úàÔ∏è [DATA_2] - [ORIGEM_2] [HORA_IDA_2] / [DESTINO_2] [HORA_CHEGADA_2][DETALHES_VOO_2]
üí∞ R$ [VALOR_2] para [PASSAGEIROS_2]
üí≥ [PAGAMENTO_2]
üîó [LINK_2]

‚ö†Ô∏è Todas as op√ß√µes s√£o SOMENTE IDA - sem retorno inclu√≠do
üìû D√∫vidas? Estamos aqui para ajudar!`,

  'A√©reo VBI/F√°cil': `*Passagem A√©rea VBI/F√°cil*
üè∑Ô∏è [COMPANHIA]
üóìÔ∏è [DATA_IDA] a [DATA_VOLTA] ([DURACAO])
‚úàÔ∏è Ida: [DATA_IDA] - [ORIGEM] [HORA_IDA] / [DESTINO] [HORA_CHEGADA_IDA][DETALHES_VOO_IDA]
‚úàÔ∏è Volta: [DATA_VOLTA] - [DESTINO] [HORA_SAIDA_VOLTA] / [ORIGEM] [HORA_CHEGADA_VOLTA][DETALHES_VOO_VOLTA]

üí∞ R$ [VALOR] para [PASSAGEIROS]
üí≥ [PAGAMENTO]
üîó [LINK]

‚ö†Ô∏è Passagem ida e volta inclu√≠da`,

  'Cruzeiro': `üö¢ Cruzeiro [NOME_NAVIO] ‚Äì [DURACAO_NOITES] noites
[COMPOSICAO_PASSAGEIROS]
üìÖ Embarque: [DATA_EMBARQUE] ([DIA_SEMANA])
üìç Sa√≠da e chegada: [PORTO_EMBARQUE]
üåä Roteiro incr√≠vel pelo litoral brasileiro!

üó∫ Itiner√°rio:
[ROTEIRO_DETALHADO]

üí• [TIPO_TARIFA]!
(Sujeita √† confirma√ß√£o de cabine e categoria)

[OPCOES_CABINES]

üìé Link para ver fotos, detalhes e reservar:
[LINK_CRUZEIRO]

‚úÖ Inclui: hospedagem a bordo, pens√£o completa (refei√ß√µes), entretenimento e atividades para todas as idades!
üö´ N√£o inclui: taxas, bebidas, excurs√µes e transporte at√© o porto.

üì≤ Me chama pra garantir a sua cabine nesse cruzeiro incr√≠vel! üå¥üõ≥Ô∏è`,

  'Hotel': `*Hospedagem*
üè® [NOME_HOTEL] - [CATEGORIA]‚≠ê
üìç [LOCALIZACAO]
üóìÔ∏è [CHECK_IN] a [CHECK_OUT] ([NOITES] noites)
üë• [ADULTOS] adultos[CRIANCAS_TEXTO]

üè† *Acomoda√ß√£o:*
[TIPO_QUARTO] com [REGIME_ALIMENTACAO]

‚úÖ *Inclui:*
‚Ä¢ [CAFE_MANHA]
‚Ä¢ [WIFI]
‚Ä¢ [SERVICOS_INCLUSOS]

üí∞ R$ [VALOR_TOTAL] para toda a estadia
üí≥ Parcelamento: [PARCELAS]x de R$ [VALOR_PARCELA]

‚ö†Ô∏è Tarifas sujeitas √† disponibilidade no momento da reserva`,

  'Carro': `*Aluguel de Carro*
üöó [MODELO_CARRO] - [CATEGORIA]
üè¢ [LOCADORA]
üìç Retirada: [LOCAL_RETIRADA]
üìç Devolu√ß√£o: [LOCAL_DEVOLUCAO]
üóìÔ∏è [DATA_RETIRADA] √†s [HORA_RETIRADA] at√© [DATA_DEVOLUCAO] √†s [HORA_DEVOLUCAO]
‚è±Ô∏è [DURACAO_DIAS] dias

üîß *Especifica√ß√µes:*
‚Ä¢ [CAMBIO] | [COMBUSTIVEL]
‚Ä¢ [AR_CONDICIONADO]
‚Ä¢ [PORTAS] portas | [PASSAGEIROS] passageiros
‚Ä¢ [BAGAGEM]

‚úÖ *Inclui:*
‚Ä¢ [QUILOMETRAGEM]
‚Ä¢ [SEGUROS_INCLUSOS]
‚Ä¢ [TAXAS_INCLUIDAS]

üí∞ R$ [VALOR_TOTAL] para [DURACAO_DIAS] dias
üí≥ [FORMA_PAGAMENTO]
üîó [LINK]

‚ö†Ô∏è Valores sujeitos √† disponibilidade. Documenta√ß√£o obrigat√≥ria: CNH v√°lida`
};

const PRECOS_MODELOS = {
  'gpt-4o': { input: 0.005, output: 0.015 },
  'gpt-4o-mini': { input: 0.00015, output: 0.0006 },
  'claude-3-5-sonnet-20240620': { input: 0.003, output: 0.015 }
};

const USD_TO_BRL = 5.2;
const MAX_TOKENS = 2500;

// ================================================================================
// üéØ HANDLER PRINCIPAL
// ================================================================================

export default async function handler(req, res) {
  const startTime = Date.now();
  
  try {
    console.log('[CLEAN-API] Iniciando processamento...');
    
    // Configura√ß√£o de CORS
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With');
    res.setHeader('Content-Type', 'application/json; charset=utf-8');

    if (req.method === 'OPTIONS') {
      return res.status(200).json({ message: 'CORS OK' });
    }

    if (req.method === 'GET') {
      return res.status(200).json({
        message: 'CVC Itaqua API - Or√ßamentos Limpos',
        version: '5.2.0-clean',
        produtos_suportados: Object.keys(TEMPLATES),
        melhorias: [
          'Or√ßamentos sem cabe√ßalhos t√©cnicos',
          'Detec√ß√£o de escalas/conex√µes',
          'Convers√£o completa de aeroportos',
          'Templates limpos para copy/paste'
        ],
        timestamp: new Date().toISOString()
      });
    }

    if (req.method !== 'POST') {
      return res.status(405).json({ 
        success: false,
        error: 'M√©todo n√£o permitido' 
      });
    }

    // VALIDA√á√ÉO
    if (!req.body?.prompt) {
      return res.status(400).json({
        success: false,
        error: 'Prompt obrigat√≥rio'
      });
    }

    const { prompt, temImagem, arquivo, tipos } = req.body;
    console.log(`[CLEAN-API] Prompt: ${prompt.length} chars, Tipos: ${tipos?.join(', ')}`);

    // AN√ÅLISE E SELE√á√ÉO DE TEMPLATE
    const analise = analisarConteudoCompleto(prompt, tipos);
    const template = selecionarTemplateCompleto(analise, tipos);
    console.log(`[CLEAN-API] Template selecionado: ${template.nome}`);

    // CONSTRUIR PROMPT LIMPO
    const promptFinal = construirPromptLimpo(prompt, template, analise, tipos);

    // CHAMADA PARA IA
    const { modelo, estrategia, fallback } = selecionarModelo(temImagem);
    const resultado = await chamarIASegura(promptFinal, temImagem, arquivo, modelo, fallback);
    
    const responseProcessada = processarResposta(resultado.content);
    const metricas = calcularMetricas(resultado, startTime, estrategia);

    console.log(`[CLEAN-API] Conclu√≠do: ${Date.now() - startTime}ms`);

    return res.status(200).json({
      success: true,
      choices: [{ 
        message: { 
          content: responseProcessada 
        } 
      }],
      metricas: metricas
    });

  } catch (error) {
    console.error('üí• [CLEAN-API ERROR] üí•', error.message);
    
    return res.status(500).json({
      success: false,
      error: {
        message: `Erro no servidor: ${error.message}`,
        type: 'SERVER_ERROR',
        version: '5.2.0-clean'
      }
    });
  }
}

// ================================================================================
// üîç AN√ÅLISE COMPLETA DE CONTE√öDO
// ================================================================================

function analisarConteudoCompleto(prompt, tipos) {
  console.log('[AN√ÅLISE-CLEAN] Analisando tipos:', tipos);
  
  if (!prompt || !tipos || tipos.length === 0) {
    return { 
      tipo: 'generico', 
      multiplasOpcoes: false,
      produtosPrincipais: ['A√©reo Facial'],
      temEscalas: false
    };
  }

  const promptLower = prompt.toLowerCase();
  
  // Detectar m√∫ltiplas op√ß√µes
  const precos = (promptLower.match(/r\$[\s]*[\d.,]+/gi) || []).length;
  const totais = (promptLower.match(/total.*\d+/gi) || []).length;
  const links = (promptLower.match(/https:\/\/www\.cvc\.com\.br/gi) || []).length;
  const companhias = (promptLower.match(/(gol|latam|azul|avianca|tap)/gi) || []).length;
  
  const multiplasOpcoes = Math.max(precos, totais, links, companhias) >= 2;
  
  // Detectar escalas/conex√µes
  const temEscalas = detectarEscalas(prompt);
  
  let tipoPrincipal = 'generico';
  
  if (tipos.includes('A√©reo Facial') || tipos.includes('A√©reo VBI/F√°cil')) {
    tipoPrincipal = 'aereo';
  } else if (tipos.includes('Hotel')) {
    tipoPrincipal = 'hotel';
  } else if (tipos.includes('Carro')) {
    tipoPrincipal = 'carro';
  } else if (tipos.includes('Cruzeiro')) {
    tipoPrincipal = 'cruzeiro';
  } else {
    tipoPrincipal = tipos[0]?.toLowerCase() || 'generico';
  }
  
  console.log(`[AN√ÅLISE-CLEAN] Tipo: ${tipoPrincipal}, M√∫ltiplas: ${multiplasOpcoes}, Escalas: ${temEscalas}`);
  
  return {
    tipo: tipoPrincipal,
    multiplasOpcoes: multiplasOpcoes,
    produtosPrincipais: tipos,
    temEscalas: temEscalas
  };
}

// ================================================================================
// üîç DETEC√á√ÉO DE ESCALAS/CONEX√ïES MELHORADA
// ================================================================================

function detectarEscalas(texto) {
  const textoLower = texto.toLowerCase();
  
  // Indicadores de escalas
  const indicadoresEscalas = [
    'uma escala', 'duas escalas', 'tr√™s escalas',
    'conex√£o', 'conexao', 'escala em', 'via ',
    'com escala', 'parada em', 'troca em',
    /\d+h\s*\d+min.*escala/i,
    /escala.*\d+h/i,
    /via\s+\w{3,}/i
  ];
  
  const temEscala = indicadoresEscalas.some(indicador => {
    if (typeof indicador === 'string') {
      return textoLower.includes(indicador);
    } else {
      return indicador.test(texto);
    }
  });
  
  // Detectar tamb√©m por tempo de voo longo (mais de 4h pode indicar escala)
  const temposVoo = texto.match(/(\d+)h\s*(\d+)?min/gi) || [];
  const temVooLongo = temposVoo.some(tempo => {
    const match = tempo.match(/(\d+)h/);
    if (match && parseInt(match[1]) >= 4) {
      return true;
    }
    return false;
  });
  
  console.log(`[ESCALAS] Detectado: ${temEscala || temVooLongo}`);
  
  return temEscala || temVooLongo;
}

// ================================================================================
// üéØ SELE√á√ÉO DE TEMPLATE COMPLETO
// ================================================================================

function selecionarTemplateCompleto(analise, tipos) {
  console.log('[TEMPLATE-CLEAN] Selecionando para:', tipos);
  
  if (!tipos || tipos.length === 0) {
    return {
      nome: 'A√©reo Facial',
      conteudo: TEMPLATES['A√©reo Facial']
    };
  }

  // Priorizar primeiro tipo selecionado
  const tipoPrincipal = tipos[0];
  
  // Para a√©reo, verificar se √© m√∫ltiplas op√ß√µes
  if (tipoPrincipal === 'A√©reo Facial' && analise.multiplasOpcoes) {
    return {
      nome: 'A√©reo M√∫ltiplas',
      conteudo: TEMPLATES['A√©reo M√∫ltiplas']
    };
  }
  
  // Buscar template espec√≠fico
  if (TEMPLATES[tipoPrincipal]) {
    return {
      nome: tipoPrincipal,
      conteudo: TEMPLATES[tipoPrincipal]
    };
  }
  
  // Fallback para a√©reo
  console.warn(`[TEMPLATE-CLEAN] Template n√£o encontrado para: ${tipoPrincipal}, usando A√©reo Facial`);
  return {
    nome: 'A√©reo Facial',
    conteudo: TEMPLATES['A√©reo Facial']
  };
}

// ================================================================================
// üèóÔ∏è PROMPT LIMPO SEM CABE√áALHOS T√âCNICOS
// ================================================================================

function construirPromptLimpo(promptBase, template, analise, tipos) {
  console.log('[PROMPT-CLEAN] Construindo prompt limpo...');
  
  const tipoPrincipal = tipos?.[0] || 'A√©reo Facial';
  
  let prompt = `Voc√™ √© um assistente especializado da CVC. Formate o or√ßamento de ${tipoPrincipal} usando EXATAMENTE o template abaixo.

IMPORTANTE: Sua resposta deve conter APENAS o or√ßamento formatado, sem cabe√ßalhos t√©cnicos, sem explica√ß√µes, sem "PRODUTO SELECIONADO", sem "M√öLTIPLAS OP√á√ïES", sem "TEMPLATE OBRIGAT√ìRIO".

TEMPLATE PARA USAR:
${template.conteudo}

DADOS DO CLIENTE:
${promptBase}

`;

  // Instru√ß√µes espec√≠ficas por tipo
  if (tipoPrincipal === 'A√©reo Facial' || tipoPrincipal === 'A√©reo VBI/F√°cil') {
    prompt += `INSTRU√á√ïES ESPEC√çFICAS PARA A√âREO:

1. **AEROPORTOS**: Converta c√≥digos IATA para nomes completos:
   - CGH = Congonhas (SP)
   - GRU = Guarulhos (SP)
   - VCP = Viracopos (SP)
   - NVT = Navegantes (SC)
   - REC = Recife (PE)
   - SSA = Salvador (BA)
   - E assim por diante para todos os c√≥digos

2. **ESCALAS/CONEX√ïES**: Se detectar escalas, adicione detalhes:
   - Para "Uma escala": adicione " (1 escala)" ap√≥s o hor√°rio
   - Para "Duas escalas": adicione " (2 escalas)" ap√≥s o hor√°rio
   - Para "Voo direto": adicione " (voo direto)" ap√≥s o hor√°rio
   - Para conex√µes espec√≠ficas: adicione " (via [cidade])" se mencionado

3. **M√öLTIPLAS OP√á√ïES**: ${analise.multiplasOpcoes ? 'Formate TODAS as op√ß√µes encontradas' : 'Formate apenas uma op√ß√£o'}

4. **LINKS**: Use os links exatos fornecidos nos dados

EXEMPLO DE SA√çDA ESPERADA:
*Passagem A√©rea - Somente Ida*
üè∑Ô∏è LATAM
üóìÔ∏è 13 de agosto (Somente ida)
‚úàÔ∏è 13 de agosto - Congonhas (SP) 08:15 / Recife (PE) 15:40 (1 escala)
üí∞ R$ 2.217,87 para 1 adulto
üí≥ N√£o reembols√°vel
üîó https://www.cvc.com.br/carrinho-dinamico/688a64568c715d91ed9badf0

‚ö†Ô∏è Passagem somente de ida - sem retorno inclu√≠do

RESPONDA APENAS COM O OR√áAMENTO FORMATADO, SEM EXPLICA√á√ïES.`;

  } else if (tipoPrincipal === 'Cruzeiro') {
    prompt += `INSTRU√á√ïES ESPEC√çFICAS PARA CRUZEIRO:

1. **FORMATO OBRIGAT√ìRIO**: Use exatamente o modelo com emojis
2. **NOME DO NAVIO**: Extraia "MSC Sinfonia" ‚Üí "MSC Sinfonia"
3. **DURA√á√ÉO**: Extraia "3 noites" 
4. **COMPOSI√á√ÉO**: "2 adultos" (ajuste se houver crian√ßas)
5. **DATA EMBARQUE**: "25/11/2025" + dia da semana se souber
6. **PORTO**: "Santos, Brasil" (sa√≠da e chegada)
7. **ROTEIRO DETALHADO**: Format como:
   25/11 ‚Äì Santos ‚Äì sa√≠da 17:00
   26/11 ‚Äì Ilha Grande ‚Äì 08:00 √†s 20:00
   27/11 ‚Äì Em navega√ß√£o
   28/11 ‚Äì Santos ‚Äì chegada 08:00

8. **OP√á√ïES DE CABINES**: Formate como:
   üõè Cabine Interna Bella ‚Äì IB: R$ 4.010,00
   üåÖ Cabine Externa com Vista Mar ‚Äì OB: R$ 4.270,00  
   üö™ Cabine com Varanda Bella ‚Äì BB: R$ 4.610,00

RESPONDA APENAS COM O CRUZEIRO FORMATADO, SEM EXPLICA√á√ïES.`;

  } else {
    prompt += `INSTRU√á√ïES GERAIS:
- Use EXATAMENTE o formato do template
- Preencha apenas com dados reais fornecidos
- N√£o invente informa√ß√µes que n√£o existem
- Mantenha links e valores exatos
- RESPONDA APENAS COM O TEMPLATE PREENCHIDO, SEM EXPLICA√á√ïES`;
  }

  return prompt;
}

// ================================================================================
// ü§ñ SISTEMA DE IA (mantido igual)
// ================================================================================

function selecionarModelo(temImagem) {
  if (temImagem === true) {
    return {
      modelo: 'claude-3-5-sonnet-20240620',
      estrategia: 'Claude para an√°lise visual',
      fallback: 'gpt-4o'
    };
  } else {
    return {
      modelo: 'gpt-4o-mini',
      estrategia: 'GPT-4o-mini para texto',
      fallback: 'gpt-4o'
    };
  }
}

async function chamarIASegura(prompt, temImagem, arquivo, modelo, fallbackModelo) {
  try {
    if (temImagem === true) {
      return await chamarClaude(prompt, arquivo, modelo);
    } else {
      return await chamarOpenAI(prompt, false, null, modelo);
    }
  } catch (erro1) {
    console.error(`‚ùå Falha principal: ${erro1.message}`);
    try {
      return await chamarOpenAI(prompt, temImagem, arquivo, fallbackModelo);
    } catch (erro2) {
      throw new Error(`Ambos modelos falharam: ${erro1.message} | ${erro2.message}`);
    }
  }
}

async function chamarClaude(prompt, arquivo, modelo) {
  if (!process.env.ANTHROPIC_API_KEY) {
    throw new Error('ANTHROPIC_API_KEY n√£o encontrada');
  }

  const base64Match = arquivo.match(/data:(image\/[^;]+);base64,(.+)/);
  if (!base64Match) {
    throw new Error('Formato de imagem base64 inv√°lido');
  }

  const content = [
    { type: "text", text: prompt },
    { type: "image", source: { type: "base64", media_type: base64Match[1], data: base64Match[2] } }
  ];

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'x-api-key': process.env.ANTHROPIC_API_KEY,
      'Content-Type': 'application/json',
      'anthropic-version': '2023-06-01'
    },
    body: JSON.stringify({
      model: modelo,
      max_tokens: MAX_TOKENS,
      messages: [{ role: 'user', content }]
    })
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Erro Claude ${response.status}: ${errorText.substring(0, 200)}`);
  }

  const data = await response.json();
  if (!data.content?.[0]?.text) {
    throw new Error('Resposta Claude inv√°lida');
  }

  return {
    content: data.content[0].text,
    usage: data.usage || { input_tokens: 0, output_tokens: 0 },
    modelo_usado: modelo
  };
}

async function chamarOpenAI(prompt, temImagem, arquivo, modelo) {
  if (!process.env.OPENAI_API_KEY) {
    throw new Error('OPENAI_API_KEY n√£o encontrada');
  }

  let messages;
  if (temImagem === true && arquivo) {
    messages = [
      {
        role: "user",
        content: [
          { type: "text", text: prompt },
          { type: "image_url", image_url: { url: arquivo } }
        ]
      }
    ];
  } else {
    messages = [{ role: "user", content: prompt }];
  }

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: modelo,
      messages: messages,
      max_tokens: MAX_TOKENS,
      temperature: 0.1
    })
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Erro OpenAI ${response.status}: ${errorText.substring(0, 200)}`);
  }

  const data = await response.json();
  if (!data.choices?.[0]?.message?.content) {
    throw new Error('Resposta OpenAI inv√°lida');
  }

  return {
    content: data.choices[0].message.content,
    usage: data.usage || { prompt_tokens: 0, completion_tokens: 0, total_tokens: 0 },
    modelo_usado: modelo
  };
}

// ================================================================================
// üîß PROCESSAMENTO MELHORADO COM CONVERS√ÉO DE AEROPORTOS
// ================================================================================

function processarResposta(response) {
  if (!response || typeof response !== 'string') {
    return 'Erro: Resposta inv√°lida';
  }

  let processada = response.trim();

  // REMOVER cabe√ßalhos t√©cnicos que possam ter vazado
  const cabecalhosRemover = [
    /PRODUTO SELECIONADO:.*?\n/gi,
    /M√öLTIPLAS OP√á√ïES:.*?\n/gi,
    /TEMPLATE OBRIGAT√ìRIO:.*?\n/gi,
    /INSTRU√á√ïES.*?\n/gi
  ];

  cabecalhosRemover.forEach(regex => {
    processada = processada.replace(regex, '');
  });

  // Convers√£o MELHORADA de aeroportos para nomes completos
  Object.entries(aeroportos).forEach(([codigo, nomeCompleto]) => {
    // Substituir c√≥digos isolados (com espa√ßos ou quebras de linha)
    const regexIsolado = new RegExp(`\\b${codigo}\\b`, 'gi');
    processada = processada.replace(regexIsolado, nomeCompleto);
    
    // Substituir c√≥digos em contextos espec√≠ficos de voo
    const regexVoo = new RegExp(`(${codigo})\\s*(\\d{2}:\\d{2})`, 'gi');
    processada = processada.replace(regexVoo, `${nomeCompleto} $2`);
  });

  // Limpar m√∫ltiplas quebras de linha
  processada = processada.replace(/\n\s*\n/g, '\n\n').trim();

  // Remover linhas vazias no in√≠cio
  processada = processada.replace(/^\s*\n+/, '');

  return processada;
}

function calcularMetricas(resultado, startTime, estrategia) {
  const tokensInput = resultado.usage?.prompt_tokens || resultado.usage?.input_tokens || 0;
  const tokensOutput = resultado.usage?.completion_tokens || resultado.usage?.output_tokens || 0;
  const modeloUsado = resultado.modelo_usado || 'desconhecido';
  
  const precosModelo = PRECOS_MODELOS[modeloUsado] || { input: 0, output: 0 };
  
  const custoUSD = (tokensInput / 1000) * precosModelo.input + (tokensOutput / 1000) * precosModelo.output;
  const custoBRL = custoUSD * USD_TO_BRL;

  const custoGPT4o = (tokensInput / 1000) * PRECOS_MODELOS['gpt-4o'].input + 
                     (tokensOutput / 1000) * PRECOS_MODELOS['gpt-4o'].output;
  const economiaUSD = custoGPT4o - custoUSD;
  const economiaBRL = economiaUSD * USD_TO_BRL;
  
  return {
    modelo_usado: modeloUsado,
    estrategia: estrategia,
    tokens: {
      input: tokensInput,
      output: tokensOutput,
      total: tokensInput + tokensOutput
    },
    custo: {
      usd: custoUSD,
      brl: custoBRL
    },
    economia: {
      vs_gpt4o_usd: economiaUSD,
      vs_gpt4o_brl: economiaBRL,
      percentual: custoGPT4o > 0 ? ((economiaUSD / custoGPT4o) * 100).toFixed(1) + '%' : '0%'
    },
    performance: {
      tempo_processamento_ms: Date.now() - startTime
    }
  };
}

console.log('‚úÖ [CLEAN-API] CVC Itaqua API v5.2.0-clean carregada');
console.log('üßπ [FOCO] Or√ßamentos limpos sem cabe√ßalhos t√©cnicos');
console.log('‚úàÔ∏è [MELHORIA] Detec√ß√£o de escalas e convers√£o completa de aeroportos');
console.log('üìã [RESULTADO] Templates prontos para copy/paste direto');
console.log('üéØ [EXEMPLO] NVT ‚Üí Navegantes (SC), CGH ‚Üí Congonhas (SP)');
console.log('üöÄ [STATUS] Pronto para gerar or√ßamentos profissionais!');
