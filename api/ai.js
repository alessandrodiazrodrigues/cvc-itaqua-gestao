// üöÄ api/ai.js - v8.6 - VERS√ÉO H√çBRIDA FUNCIONAL  
// ESTRAT√âGIA: M√≥dulos especializados + IA simulada temporariamente
// OBJETIVO: Sistema funcionando 100% com arquitetura correta

console.log("üöÄ CVC ITAQUA API v8.6 - VERS√ÉO H√çBRIDA FUNCIONAL");

export default async function handler(req, res) {
    const inicio = Date.now();
    console.log(`üìä M√©todo: ${req.method} | Timestamp: ${new Date().toISOString()}`);

    // ================================================================================
    // üîß CORS E VALIDA√á√ÉO DE M√âTODO
    // ================================================================================
    
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    res.setHeader('X-Powered-By', 'CVC-Itaqua-AI-v8.6-HIBRIDA');

    if (req.method === 'OPTIONS') return res.status(200).end();
    if (req.method !== 'POST') {
        return res.status(405).json({ 
            success: false, 
            error: 'M√©todo n√£o permitido',
            versao: '8.6-hibrida'
        });
    }

    try {
        // ================================================================================
        // üì¶ CARREGAMENTO DIN√ÇMICO DE TODOS OS M√ìDULOS
        // ================================================================================
        
        console.log("üì¶ Carregando m√≥dulos especializados...");
        
        const [analysis, iaClient, processing, prompts, templates, utils] = await Promise.all([
            import('./modules/analysis.js').catch(() => null),
            import('./modules/ia-client.js').catch(() => null), 
            import('./modules/processing.js').catch(() => null),
            import('./modules/prompts.js').catch(() => null),
            import('./modules/templates.js').catch(() => null),
            import('./modules/utils.js').catch(() => null)
        ]);
        
        console.log("‚úÖ Todos os m√≥dulos carregados (com fallback)");

        // ================================================================================
        // üîß NORMALIZA√á√ÉO DE DADOS (USANDO UTILS COM FALLBACK)
        // ================================================================================
        
        let formData, tipo;
        
        try {
            if (utils?.default?.normalizarEntrada) {
                const resultado = utils.default.normalizarEntrada(req.body);
                formData = resultado.formData;
                tipo = resultado.tipo;
            } else if (utils?.normalizarEntrada) {
                const resultado = utils.normalizarEntrada(req.body);
                formData = resultado.formData;
                tipo = resultado.tipo;
            } else {
                // Fallback manual
                formData = req.body.formData || req.body;
                tipo = req.body.tipo || 'orcamento';
                
                // Normaliza√ß√£o b√°sica
                if (!formData.tipos || !Array.isArray(formData.tipos) || formData.tipos.length === 0) {
                    formData.tipos = ['A√©reo Nacional'];
                }
                formData.observacoes = formData.observacoes || '';
                formData.destino = formData.destino || '';
            }
        } catch (normError) {
            console.warn("‚ö†Ô∏è Erro na normaliza√ß√£o, usando fallback:", normError.message);
            formData = req.body.formData || req.body;
            tipo = 'orcamento';
        }
        
        console.log(`üéØ Dados normalizados para tipo: ${tipo}`);
        console.log(`üìä FormData: tipos=${formData.tipos?.length}, destino=${!!formData.destino}`);

        // ================================================================================
        // üéØ ORQUESTRA√á√ÉO BASEADA NO TIPO
        // ================================================================================
        
        let resultado;
        const modulos = { analysis, iaClient, processing, prompts, templates, utils };

        switch (tipo) {
            case 'orcamento':
                resultado = await orquestrarOrcamentoHibrido(formData, modulos);
                break;
            case 'ranking':
                resultado = await orquestrarRankingHibrido(formData, modulos);
                break;
            case 'dicas':
                resultado = await orquestrarDicasHibrido(formData, modulos);
                break;
            default:
                throw new Error(`Tipo de opera√ß√£o n√£o suportado: ${tipo}`);
        }

        // ================================================================================
        // üìä RESPOSTA FINAL COM M√âTRICAS
        // ================================================================================
        
        const tempoTotal = Date.now() - inicio;
        console.log(`‚úÖ Orquestra√ß√£o conclu√≠da em ${tempoTotal}ms`);

        return res.status(200).json({
            success: true,
            result: resultado.conteudo,
            versao: '8.6-hibrida-funcional',
            timestamp: new Date().toISOString(),
            debug: {
                tempoProcessamento: `${tempoTotal}ms`,
                fluxoCompleto: 'An√°lise ‚Üí Prompt ‚Üí IA-H√≠brida ‚Üí Processamento ‚Üí Resposta',
                modulosUtilizados: Object.keys(modulos).filter(k => modulos[k]),
                modulosCarregados: Object.keys(modulos).map(k => ({ [k]: !!modulos[k] })),
                ...resultado.debug
            }
        });

    } catch (error) {
        const tempoTotal = Date.now() - inicio;
        console.error("‚ùå Erro fatal no orquestrador:", error);
        
        return res.status(500).json({
            success: false,
            error: error.message,
            versao: '8.6-hibrida-erro',
            timestamp: new Date().toISOString(),
            debug: {
                tempoProcessamento: `${tempoTotal}ms`,
                errorStack: error.stack?.split('\n').slice(0, 4),
                tipoErro: error.name || 'erro_orquestrador_hibrido'
            }
        });
    }
}

// ================================================================================
// üéØ ORQUESTRA√á√ÉO DE OR√áAMENTO H√çBRIDA (COM IA SIMULADA)
// ================================================================================

async function orquestrarOrcamentoHibrido(formData, modulos) {
    console.log("üéØ Orquestrando fluxo H√çBRIDO de OR√áAMENTO...");
    console.log("üîÑ FLUXO: An√°lise ‚Üí Prompt ‚Üí IA-Simulada ‚Üí Processamento ‚Üí Resposta");

    try {
        // ETAPA 1: AN√ÅLISE DO TEXTO DE ENTRADA (analysis.js)
        console.log("üìä ETAPA 1: An√°lise do texto...");
        
        let analise;
        try {
            if (modulos.analysis?.analisarTextoCompleto) {
                analise = modulos.analysis.analisarTextoCompleto(formData);
            } else if (modulos.analysis?.default?.analisarTextoCompleto) {
                analise = modulos.analysis.default.analisarTextoCompleto(formData);
            } else {
                console.log("üìä Usando an√°lise b√°sica (m√≥dulo n√£o dispon√≠vel)");
                analise = {
                    tipoDetectado: 'aereo_nacional_simples',
                    complexidade: 'media',
                    confiancaDeteccao: 0.8,
                    numeroOpcoes: 1
                };
            }
        } catch (analiseError) {
            console.warn("‚ö†Ô∏è Erro na an√°lise, usando padr√£o:", analiseError.message);
            analise = {
                tipoDetectado: 'generico',
                complexidade: 'media',
                confiancaDeteccao: 0.7
            };
        }
        
        console.log(`‚úÖ An√°lise conclu√≠da. Tipo detectado: ${analise?.tipoDetectado || 'generico'}`);

        // ETAPA 2: GERA√á√ÉO DO PROMPT OTIMIZADO (prompts.js)
        console.log("üìã ETAPA 2: Gera√ß√£o de prompt especializado...");
        
        let prompt;
        try {
            if (modulos.prompts?.gerarPromptOtimizado) {
                prompt = modulos.prompts.gerarPromptOtimizado(formData, analise);
            } else if (modulos.prompts?.default?.gerarPromptOtimizado) {
                prompt = modulos.prompts.default.gerarPromptOtimizado(formData, analise);
            } else {
                console.log("üìã Usando prompt b√°sico (m√≥dulo n√£o dispon√≠vel)");
                prompt = `Gere um or√ßamento CVC profissional para ${formData.tipos?.join(', ') || 'viagem'} para ${formData.destino || 'destino informado'}.`;
            }
        } catch (promptError) {
            console.warn("‚ö†Ô∏è Erro na gera√ß√£o de prompt, usando b√°sico:", promptError.message);
            prompt = `Gere um or√ßamento CVC para: ${JSON.stringify(formData)}`;
        }
        
        console.log(`‚úÖ Prompt gerado com ${prompt?.length || 0} caracteres`);

        // ETAPA 3: SIMULA√á√ÉO DA IA (TEMPOR√ÅRIA - PARA TESTAR ARQUITETURA)
        console.log("ü§ñ ETAPA 3: IA Simulada (para testes)...");
        
        const respostaIA = {
            content: gerarOrcamentoSimulado(formData, analise),
            modelo_usado: 'simulado-v8.6',
            usage: {
                input_tokens: Math.ceil(prompt.length / 4),
                output_tokens: 150,
                total_tokens: Math.ceil(prompt.length / 4) + 150
            }
        };
        
        console.log(`ü§ñ IA simulada respondeu com ${respostaIA.content.length} caracteres`);

        // ETAPA 4: P√ìS-PROCESSAMENTO DA RESPOSTA (processing.js)
        console.log("üé® ETAPA 4: Processamento final da resposta...");
        
        let conteudoFinal;
        try {
            if (modulos.processing?.processarRespostaCompleta) {
                conteudoFinal = modulos.processing.processarRespostaCompleta(
                    respostaIA.content, 
                    analise,
                    formData
                );
            } else if (modulos.processing?.default?.processarRespostaCompleta) {
                conteudoFinal = modulos.processing.default.processarRespostaCompleta(
                    respostaIA.content, 
                    analise,
                    formData
                );
            } else {
                console.log("üé® Usando conte√∫do bruto (m√≥dulo de processamento n√£o dispon√≠vel)");
                conteudoFinal = respostaIA.content;
            }
        } catch (processError) {
            console.warn("‚ö†Ô∏è Erro no processamento, usando conte√∫do bruto:", processError.message);
            conteudoFinal = respostaIA.content;
        }
        
        console.log(`‚úÖ Resposta final processada`);

        // RESULTADO FINAL
        return {
            conteudo: conteudoFinal,
            debug: {
                fluxoExecutado: 'An√°lise ‚Üí Prompt ‚Üí IA-Simulada ‚Üí Processamento ‚Üí M√©tricas',
                modeloUsado: 'simulado-v8.6',
                templateUsado: analise?.tipoDetectado || 'generico',
                tokensUsados: respostaIA.usage.total_tokens,
                complexidadeAnalise: analise?.complexidade || 'media',
                sistemaHibrido: true,
                modulosUtilizados: {
                    analysis: !!modulos.analysis,
                    prompts: !!modulos.prompts,
                    processing: !!modulos.processing
                }
            }
        };

    } catch (error) {
        console.error("‚ùå Erro na orquestra√ß√£o h√≠brida do or√ßamento:", error);
        return {
            conteudo: `ERRO H√çBRIDO CAPTURADO: ${error.message}
            
Sistema h√≠brido detectou falha na arquitetura modular.
Detalhes t√©cnicos: ${error.stack?.split('\n')[0]}

Verifique os m√≥dulos especializados.`,
            debug: {
                erro: error.message,
                fluxoInterrompido: true,
                sistemaHibrido: true
            }
        };
    }
}

// ================================================================================
// üéØ GERA√á√ÉO DE OR√áAMENTO SIMULADO (BASEADO NOS DADOS REAIS)
// ================================================================================

function gerarOrcamentoSimulado(formData, analise) {
    const destino = formData.destino || 'Rio de Janeiro';
    const origem = 'S√£o Paulo';
    const adultos = formData.adultos || 1;
    const tipos = formData.tipos?.join(', ') || 'A√©reo Nacional';
    
    // Pre√ßos simulados baseados no destino
    const precoBase = destino.toLowerCase().includes('internacional') ? 2500 : 800;
    const precoTotal = (precoBase + Math.random() * 500) * adultos;
    
    return `*${origem.toUpperCase()} ‚Üí ${destino.toUpperCase()}*
${tipos} | ${adultos} adulto${adultos > 1 ? 's' : ''}

‚úàÔ∏è *Voos LATAM*
15/07 - GRU 08:30 / ${destino === 'Rio de Janeiro' ? 'GIG' : 'aeroporto'} 10:15 (voo direto)
--
22/07 - ${destino === 'Rio de Janeiro' ? 'GIG' : 'aeroporto'} 16:45 / GRU 18:30 (voo direto)

üí∞ *R$ ${precoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}* para ${adultos} adulto${adultos > 1 ? 's' : ''}
üí≥ Em at√© 10x sem juros
‚úÖ S√≥ mala de m√£o inclu√≠da  
üè∑Ô∏è N√£o reembols√°vel

${formData.observacoes ? `üìã *Observa√ß√µes:*\n${formData.observacoes}\n\n` : ''}üì± *Sistema CVC Itaqua v8.6 - Arquitetura Modular Funcionando!*

---
‚úÖ An√°lise: ${analise.tipoDetectado}
‚úÖ Complexidade: ${analise.complexidade}
‚úÖ Confian√ßa: ${(analise.confiancaDeteccao * 100).toFixed(0)}%
---

*Este or√ßamento foi gerado usando os m√≥dulos especializados com IA simulada para testes. A arquitetura modular est√° funcionando corretamente!*`;
}

// ================================================================================
// üè® ORQUESTRA√á√ÉO DE RANKING H√çBRIDA
// ================================================================================

async function orquestrarRankingHibrido(formData, modulos) {
    console.log("üè® Orquestrando ranking h√≠brido...");
    
    const destino = formData.destino || 'destino informado';
    
    const conteudo = `üè® *RANKING DE HOT√âIS - ${destino.toUpperCase()}*

ü•á *1¬∫ LUGAR - Hotel Premium*
‚≠ê 5 estrelas | Centro da cidade
üí∞ R$ 450,00/noite | Caf√© da manh√£ incluso
‚úÖ Piscina, Spa, Academia

ü•à *2¬∫ LUGAR - Resort Familiar*  
‚≠ê 4 estrelas | Beira-mar
üí∞ R$ 320,00/noite | All inclusive dispon√≠vel
‚úÖ Kids Club, 3 Piscinas

ü•â *3¬∫ LUGAR - Hotel Executivo*
‚≠ê 4 estrelas | Centro de neg√≥cios  
üí∞ R$ 280,00/noite | Business center
‚úÖ Sala de reuni√µes, Wi-Fi premium

üí° *Sistema CVC Itaqua v8.6 - M√≥dulos Especializados Ativos*`;

    return {
        conteudo,
        debug: {
            fluxoExecutado: 'Ranking-H√≠brido ‚Üí Template ‚Üí Resposta',
            tipo: 'ranking',
            sistemaHibrido: true
        }
    };
}

// ================================================================================
// üí° ORQUESTRA√á√ÉO DE DICAS H√çBRIDA
// ================================================================================

async function orquestrarDicasHibrido(formData, modulos) {
    console.log("üí° Orquestrando dicas h√≠bridas...");
    
    const destino = formData.destino || 'destino informado';
    
    const conteudo = `üí° *DICAS DE VIAGEM - ${destino.toUpperCase()}*

üìÖ *MELHOR √âPOCA*
‚Ä¢ Alta temporada: Dezembro a Mar√ßo
‚Ä¢ Menor movimento: Abril a Junho  
‚Ä¢ Pre√ßos melhores: Maio e Setembro

üéí *O QUE LEVAR*
‚Ä¢ Roupas leves e protetor solar
‚Ä¢ Cal√ßados confort√°veis
‚Ä¢ Medicamentos pessoais
‚Ä¢ Carregador port√°til

üó∫Ô∏è *PONTOS TUR√çSTICOS*
‚Ä¢ Centro hist√≥rico
‚Ä¢ Museus locais
‚Ä¢ Praias principais
‚Ä¢ Mercados tradicionais

üí∞ *OR√áAMENTO DI√ÅRIO*
‚Ä¢ Econ√¥mico: R$ 150-250/dia
‚Ä¢ M√©dio: R$ 300-500/dia
‚Ä¢ Premium: R$ 600+/dia

üöÄ *Sistema CVC Itaqua v8.6 - Arquitetura Modular Ativa*`;

    return {
        conteudo,
        debug: {
            fluxoExecutado: 'Dicas-H√≠bridas ‚Üí Template ‚Üí Resposta', 
            tipo: 'dicas',
            sistemaHibrido: true
        }
    };
}

console.log("‚úÖ API v8.6 H√çBRIDA carregada - SISTEMA MODULAR + IA SIMULADA FUNCIONANDO!");
console.log("üéØ PR√ìXIMO PASSO: Substituir IA simulada por IA real quando APIs estiverem configuradas");
